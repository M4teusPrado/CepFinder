name: Cep Finder

on:
  push:
      branchs: [main]

jobs:
    builds:
        runs-on: ubuntu-latest
        steps:
          - name: Checkout code
            uses: actions/checkout@v3

          - name: Setup Java
            uses: actions/setup-java@v3
            with:
                distribution: 'temurin'
                java-version: '17'
          - name: Build project
            run: mvn clean install -DskipTests
          - name: Login Docker Hub
            run: docker login -u ${{secrets.DOCKER_USERNAME}} -p ${{secrets.DOCKER_PASSWORD}}
          - name: Build docker image
            run: docker build -t  ${{secrets.DOCKER_USERNAME}}/cepfinder .
          - name: Push image docker
            run: docker push ${{secrets.DOCKER_USERNAME}}/cepfinder
    deploy:
        needs: build
        runs-on: self-hosted  # A máquina onde o Docker e Docker Compose estão configurados
        steps:
          - name: Copy docker-compose.yml to the deploy machine
            run: |
              scp -i docker-compose.yml ec2-user@ec2-54-174-204-170.compute-1.amazonaws.com:/home/ec2-user

          - name: SSH to deploy machine and run Docker Compose
            run: |
              ssh -i ec2-user@ec2-54-174-204-170.compute-1.amazonaws.com "cd /home/ec2-user && docker-compose up -d"
